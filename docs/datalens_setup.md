# Настройка DataLens для дашборда аналитики Room Broom

**Назначение:** инструкция по подключению DataLens к Neon и созданию дашборда с 15 метриками.

## Подключение к Neon

1. В DataLens создайте новый **подключение** → **PostgreSQL**
2. Укажите connection string из `NEON_DATABASE_URL` (из GitHub Secrets или `.env`)
3. Протестируйте подключение

## Создание датасетов

### Датасет 1: Ежедневные метрики (`mart_daily_metrics`)

**Таблица:** `mart_daily_metrics`

**Поля для визуализации:**

1. **Выручка по дням** (доставка + самовывоз)
   - Поле: `revenue`
   - Тип: Число, формат: Деньги

2. **% скидки по дням** (доставка + самовывоз)
   - Поле: `discount_percent`
   - Тип: Число, формат: Процент

3. **% рекламный бюджет + ФОТ директ**
   - Поля: `ad_budget_percent`, `fot_direct_percent`
   - Тип: Число, формат: Процент

4. **% себестоимости** (доставка + самовывоз)
   - Поле: `cost_percent`
   - Тип: Число, формат: Процент

5. **% ФОТ курьеры**
   - Поле: `fot_couriers_percent`
   - Тип: Число, формат: Процент

6. **Потрачено руб на Упаковку**
   - Поле: `packaging_cost`
   - Тип: Число, формат: Деньги

7. **Потрачено руб на Арору**
   - Поле: `arora_cost`
   - Тип: Число, формат: Деньги

8. **Потрачено руб на Налоги**
   - Поле: `taxes_cost`
   - Тип: Число, формат: Деньги

9. **Потрачено руб на Эквайринг**
   - Поле: `acquiring_cost`
   - Тип: Число, формат: Деньги

10. **Итого маржа по дням** (доставка + самовывоз)
    - Поле: `margin`
    - Тип: Число, формат: Деньги

11. **ФОТ повара**
    - Поле: `fot_cooks`
    - Тип: Число, формат: Деньги
    - Процент: `fot_cooks_percent`

12. **ФОТ уборщицы**
    - Поле: `fot_cleaners`
    - Тип: Число, формат: Деньги
    - Процент: `fot_cleaners_percent`

**Группировки:**
- `report_date` (Дата) — для фильтрации по периодам
- `department` (Торговое предприятие) — Домодедово / Авиагородок

### Датасет 2: Нагрузка по часам (`mart_hourly_load`)

**Таблица:** `mart_hourly_load`

**Поля:**

13. **Нагрузка по дням и по часам по кол-ву заказов** (доставка + самовывоз)
    - Поле: `orders_count`
    - Тип: Число

14. **Нагрузка по дням и по часам по выручке** (доставка + самовывоз)
    - Поле: `revenue`
    - Тип: Число, формат: Деньги

**Группировки:**
- `report_date` (Дата)
- `hour_open` (Час открытия, 0-23)
- `department` (Торговое предприятие)

### Датасет 3: Типы скидок (`mart_discount_types`)

**Таблица:** `mart_discount_types`

**Поля:**

15. **Типы скидок по дням**
    - `discount_type` — Тип скидки
    - `orders_count` — Количество заказов со скидкой
    - `revenue_with_discount` — Выручка с заказов со скидкой
    - `discount_sum` — Сумма общей по скидке
    - `average_check` — Средний чек по заказам со скидкой

**Группировки:**
- `report_date` (Дата)
- `department` (Торговое предприятие)
- `discount_type` (Тип скидки)

## Создание дашборда

1. Создайте новый **дашборд** в DataLens
2. Добавьте **чарты** на основе созданных датасетов:

   **Виджеты для ежедневных метрик:**
   - График выручки по дням (линейный график)
   - Индикаторы % скидки, % себестоимости, % маржи
   - Таблица всех расходов (упаковка, арору, налоги, эквайринг)
   - График маржи по дням

   **Виджеты для нагрузки:**
   - Тепловая карта нагрузки по часам (заказы)
   - Тепловая карта нагрузки по часам (выручка)

   **Виджеты для скидок:**
   - Таблица типов скидок с агрегатами
   - График распределения скидок по типам

3. Добавьте **фильтры:**
   - Период (дата начала / дата окончания)
   - Торговое предприятие (Домодедово / Авиагородок)

4. Настройте **автообновление** дашборда (рекомендуется ежедневно после завершения ETL)

## Рекомендации

- Используйте **кэширование** для ускорения работы дашборда
- Настройте **алерты** на критические метрики (например, отрицательная маржа)
- Добавьте **сравнение периодов** (текущий месяц vs предыдущий месяц)
- Создайте **экспорт** данных в Excel для детального анализа
