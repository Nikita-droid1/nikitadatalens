# Пошаговая настройка проекта

## Архитектура

```
GitHub (код + секреты + Actions) 
  ↓
iiko Server API (выгрузка данных)
  ↓
Neon (БД + постобработка)
  ↓
DataLens (визуализация)
```

---

## ШАГ 0: Добавление кода и Actions в GitHub

**Цель:** Закоммитить код проекта в репозиторий, чтобы Actions workflow стал доступен.

**Что значит "закоммитить"?** Это сохранить код в Git и отправить его на GitHub. Подробная инструкция: см. `docs/git_basics.md`

**Кратко:**

1. Создайте репозиторий на GitHub (или используйте существующий)
2. Закоммитьте и запушите весь код проекта:
   ```bash
   git add .
   git commit -m "Initial commit: ETL pipeline for Room Broom analytics"
   git push origin main
   ```
   Или используйте GitHub Desktop / VS Code (см. `docs/git_basics.md`)

3. Проверьте, что файл `.github/workflows/daily_etl.yml` попал в репозиторий
4. Убедитесь, что файл `.env` НЕ попал в репозиторий (он должен быть в `.gitignore`)

**Проверка:** Откройте репозиторий на GitHub → вкладка **Actions** → должен появиться workflow "Daily ETL"

---

## ШАГ 1: Настройка GitHub Secrets

**Цель:** Добавить все секреты в GitHub для работы Actions.

1. Откройте репозиторий на GitHub
2. Перейдите: **Settings** → **Secrets and variables** → **Actions**
3. Нажмите **New repository secret**
4. Добавьте следующие секреты (значения берите из вашего `.env`):

| Имя секрета | Значение из .env | Пример |
|-------------|------------------|--------|
| `IIKO_BASE_URL` | `IIKO_BASE_URL` | `https://oreks-co.Iiko.it:443` |
| `IIKO_LOGIN` | `IIKO_LOGIN` | `UKK` |
| `IIKO_PASSWORD_SHA1` | `IIKO_PASSWORD_SHA1` | `2c61422714bcb5935215adf442a8f5b1d80ffc54` |
| `NEON_DATABASE_URL` | *(нужно получить из Neon)* | `postgresql://user:pass@host/db?sslmode=require` |
| `GOOGLE_SHEETS_CREDENTIALS` | *(опционально, если используете Google Sheets)* | `{"type": "service_account", ...}` |

**✅ Проверка:** Все 4-5 секретов добавлены в GitHub.

---

## ШАГ 2: Создание БД в Neon

**Цель:** Создать базу данных и выполнить SQL схемы.

### 2.1. Создание проекта в Neon

1. Зайдите на [neon.tech](https://neon.tech)
2. Создайте новый проект
3. Запомните **Connection string** (будет нужен для шага 1)

### 2.2. Выполнение SQL схем

1. Откройте SQL Editor в Neon
2. Выполните файлы **по порядку**:

   **Файл 1:** `neon/schema/001_iiko_raw.sql`
   - Создает таблицы для сырых данных из iiko API
   - Копируйте содержимое файла и выполните в SQL Editor

   **Файл 2:** `neon/schema/002_sheets_raw.sql`
   - Создает таблицы для данных из Google Sheets
   - Копируйте содержимое файла и выполните в SQL Editor

   **Файл 3:** `neon/schema/003_mart.sql`
   - Создает витрину данных для DataLens
   - Копируйте содержимое файла и выполните в SQL Editor

**✅ Проверка:** В Neon созданы таблицы:
- `iiko_raw_margin`
- `iiko_raw_load_orders`
- `iiko_raw_load_revenue`
- `iiko_raw_discount_types`
- `sheets_raw_direct`
- `sheets_raw_fot`
- `mart_daily_metrics`
- `mart_hourly_load`
- `mart_discount_types`

---

## ШАГ 3: Тестовый запуск GitHub Actions (ручной)

**Цель:** Проверить, что выгрузка данных работает.

1. Откройте репозиторий на GitHub
2. Перейдите: **Actions** → **"ETL (ручной запуск)"**
3. Нажмите **Run workflow** (кнопка справа)
4. Выберите ветку (обычно `main`)
5. Нажмите **Run workflow**
6. Дождитесь завершения (обычно 1-2 минуты)
7. Проверьте логи:
   - ✅ Должно быть: "Token получен", "Загружено X строк"
   - ❌ Если ошибка — проверьте секреты и логи

**Важно:** ETL запускается только вручную через эту кнопку. Автоматический запуск по расписанию отключен.

**✅ Проверка:** В логах Actions видно успешную загрузку данных.

---

## ШАГ 4: Проверка данных в Neon

**Цель:** Убедиться, что данные загрузились в БД.

1. Откройте Neon SQL Editor
2. Выполните запросы:

```sql
-- Проверка загрузки данных из iiko
SELECT COUNT(*) FROM iiko_raw_margin;
SELECT COUNT(*) FROM iiko_raw_load_orders;
SELECT COUNT(*) FROM iiko_raw_load_revenue;
SELECT COUNT(*) FROM iiko_raw_discount_types;

-- Проверка витрины (после трансформаций)
SELECT COUNT(*) FROM mart_daily_metrics;
SELECT * FROM mart_daily_metrics ORDER BY report_date DESC LIMIT 5;
```

**✅ Проверка:** В таблицах есть данные.

---

## ШАГ 5: Запуск трансформаций (если не запускались автоматически)

**Цель:** Обновить витрину данных с расчетом всех метрик.

1. В Neon SQL Editor выполните файл `neon/transforms/refresh_mart.sql`
2. Или запустите через GitHub Actions (шаг "Run transforms" должен выполниться автоматически)

**✅ Проверка:** В `mart_daily_metrics` есть данные с рассчитанными метриками.

---

## ШАГ 6: Настройка DataLens

**Цель:** Подключить DataLens к Neon и создать дашборд.

1. Откройте [DataLens](https://datalens.yandex.ru)
2. Создайте новое подключение → **PostgreSQL**
3. Вставьте **Connection string** из Neon (тот же, что в секретах GitHub)
4. Протестируйте подключение
5. Создайте датасеты на основе таблиц `mart_*` (см. `docs/datalens_setup.md`)
6. Создайте дашборд с 15 метриками

**✅ Проверка:** Дашборд показывает данные из Neon.

---

## Что дальше?

- **Ежедневно:** GitHub Actions автоматически запускается в 02:00 UTC (05:00 МСК)
- **Вручную:** Можно запустить через Actions → Daily ETL → Run workflow
- **Обновление дашборда:** DataLens автоматически подтягивает новые данные из Neon

---

## Возможные проблемы

### Ошибка подключения к iiko API
- Проверьте секреты `IIKO_BASE_URL`, `IIKO_LOGIN`, `IIKO_PASSWORD_SHA1`
- Убедитесь, что у пользователя API есть права на просмотр отчетов

### Ошибка подключения к Neon
- Проверьте `NEON_DATABASE_URL` в секретах GitHub
- Убедитесь, что БД доступна и схемы созданы

### Данные не загружаются
- Проверьте логи GitHub Actions
- Проверьте формат ответа от iiko API (может отличаться от ожидаемого)
