# Yandex DataLens

**Назначение:** подключение к Neon и создание датасетов и дашбордов маркетинговой аналитики.

## Подключение к Neon (PostgreSQL)

1. В [Yandex DataLens](https://datalens.yandex.ru) перейти в **Подключения** → **Создать подключение** → **PostgreSQL**.
2. Взять данные из консоли [Neon](https://neon.tech): Dashboard → ваш проект → Connection string (или Host, Port, Database, User, Password).
3. Заполнить в DataLens поля (см. таблицу ниже).
4. Нажать **Проверить подключение**, затем **Создать** и назвать подключение (например, «Neon — маркетинг»).

### Параметры из NEON_DATABASE_URL

Если строка подключения уже есть (из GitHub Secrets или `.env`), её можно разобрать вручную. Формат:

`postgresql://USER:PASSWORD@HOST/DBNAME?sslmode=require&channel_binding=require`

| Поле в DataLens | Откуда взять |
|-----------------|--------------|
| **Хост** | Часть между `@` и следующим `/` (например `ep-steep-tree-ahpsn203-pooler.c-3.us-east-1.aws.neon.tech`) |
| **Порт** | 5432 |
| **Имя БД** | После последнего `/` до `?` (например `neondb`) |
| **Пользователь** | Часть после `://` до первого `:` (например `neondb_owner`) |
| **Пароль** | Между `USER:` и `@` (в Neon: Connection string → **Show password**) |
| **SSL** | Включить (обязательно для Neon) |

Пароль в репозитории не хранить — подставлять только в интерфейсе DataLens и в локальном `.env`.

## Датасеты

После создания подключения к Neon: **Датасеты** → **Создать датасет** → выбрать созданное подключение → указать нужную таблицу.

- **mart_sales_by_day** — витрина для маркетинга. Поля: `report_date`, `organization_id`, `organization_name`, `revenue`, `orders_count`, `avg_check`, `refreshed_at`.
- **margin_iiko** — маржа по дням и департаментам. Поля: `department`, `oper_day`, `revenue`, `discount`, `product_cost`, `revenue_courier`, `discount_courier`, `product_cost_courier`, `revenue_pickup`, `discount_pickup`, `product_cost_pickup`, `updated_at`. Вычисляемые в датасете: маржа = revenue − product_cost, % скидки, % себестоимости.
- **load_hourly_iiko** — нагрузка по часам. Поля: `department`, `oper_day`, `hour`, `orders_count`, `revenue`, `discount`, `updated_at`.
- **discount_types_daily_iiko** — типы скидок по дням. Поля: `department`, `oper_day`, `discount_type`, `orders_count`, `revenue`, `discount_sum`, `updated_at`. Вычисляемое: средний чек = revenue / orders_count.
- **iiko_raw_export** — сырые выгрузки. Поля: `id`, `exported_at`, `payload` (JSONB).

## Дашборд «Маржа»

Для воспроизведения дашборда как у коллеги (сводная маржа, нагрузка по часам, типы скидок):

1. Создать **три датасета** на таблицах margin_iiko, load_hourly_iiko, discount_types_daily_iiko (см. выше; в датасете «Маржа» добавить вычисляемые поля: маржа, % скидки, % себестоимости; в «Типы скидок» — средний чек).
2. Создать дашборд, добавить **фильтры**: Учётный день (диапазон), День недели, Торговое предприятие (department), Будни/Выхи.
3. Добавить **виджеты**: (1) Сводная таблица «Маржа» — метрики по строкам, даты по столбцам, заливка зелёный–красный; (2) Сетка «Нагрузка по часам — Заказы» (дата × час, значение — заказы); (3) Сетка «Нагрузка по часам — Выручка» (дата × час, выручка); (4) Таблица по дням (Выручка, Заказов, Скидка по oper_day); (5) Фильтр «Тип скидки»; (6) Сводная «Типы скидок» (день × Заказов, Выручка, Скидка, Средний чек).

Подробный состав — в плане дашборда (см. .cursor/plans или docs).

## Дашборды (общие)

Рекомендуемые виджеты для маркетинговой аналитики:

- Выручка по кафе (organization_name) и по периодам (report_date).
- Динамика выручки и среднего чека по дням/неделям.
- Количество заказов по точкам.
- Сравнение метрик между кафе (таблица или барчарты).

## Документация

- **docs/** — описание дашбордов, скриншоты, инструкции для пользователей; кого приглашать в DataLens и с какими правами.
